<section class="player-wrap">
  <h2>Reproducir presentaci√≥n</h2>

  <!-- Mensajes -->
  <div *ngIf="loading">Cargando audio‚Ä¶</div>
  <div *ngIf="!loading && error" class="alert-error">{{ error }}</div>

  <!-- ========================= -->
  <!-- üéß TARJETA AUDIO ORIGINAL -->
  <!-- ========================= -->
  <div *ngIf="!error" class="player-card">
    <h3 class="card-title">Audio original del estudiante</h3>

    <div class="player-header">
      <div class="time">
        {{ formatTime(currentTime) }} / {{ formatTime(duration) }}
      </div>

      <div class="speed">
        Velocidad:
        <select [(ngModel)]="playbackRate" (change)="changeSpeed()">
          <option [value]="0.75">0.75x</option>
          <option [value]="1">1.0x</option>
          <option [value]="1.25">1.25x</option>
          <option [value]="1.5">1.5x</option>
        </select>
      </div>
    </div>

    <!-- Waveform original -->
    <div #waveform class="waveform"></div>

    <div class="player-controls">
      <button type="button" (click)="togglePlay()" [disabled]="!waveReady">
        {{ isPlaying ? 'Pausar' : 'Reproducir' }}
      </button>
      <button type="button" (click)="stop()" [disabled]="!waveReady">
        Detener
      </button>
    </div>

    <audio #audioRef preload="auto" style="display:none"></audio>

    <p *ngIf="!loading && !error && !audioUrl" class="no-audio">
      Vista creada correctamente. Falta conectar el audio del backend.
    </p>
  </div>

  <!-- ========================== -->
  <!-- üìÑ TRANSCRIPCI√ìN (COLAPSABLE Y EN EL MEDIO) -->
  <!-- ========================== -->
  <div class="transcription-card" *ngIf="transcription || transcriptionLoading || transcriptionError">

    <!-- Header clickable -->
    <div class="transcription-header" (click)="showTranscription = !showTranscription">
      <span class="toggle-icon">{{ showTranscription ? '‚ñæ' : '‚ñ∏' }}</span>
      <h3>Transcripci√≥n</h3>
    </div>

    <!-- Contenido colapsable -->
    <div *ngIf="showTranscription" class="transcription-content">

      <p *ngIf="transcriptionLoading">Cargando transcripci√≥n‚Ä¶</p>

      <p *ngIf="transcriptionError" class="alert-error">
        {{ transcriptionError }}
      </p>

      <div *ngIf="transcription" class="transcription-body">
        {{ transcription }}
      </div>

    </div>
  </div>


  <!-- ========================== -->
  <!-- üîä AUDIO TTS DE REFERENCIA -->
  <!-- ========================== -->
  <div class="player-card tts-card">
    <h3 class="card-title">Audio de referencia (Asistente de voz)</h3>

    <p class="card-description">
      Este audio es una gu√≠a generada autom√°ticamente a partir de tu transcripci√≥n.
      Te ayuda a escuchar una exposici√≥n clara, pausada y segura.
    </p>

    <!-- Bot√≥n solo si NO existe audio TTS -->
    <button
      *ngIf="!ttsAudioUrl"
      type="button"
      class="tts-btn"
      (click)="openVoiceModal()"
      [disabled]="ttsLoading"
    >
      Generar audio de referencia
    </button>
    <p *ngIf="ttsAudioUrl && !ttsLoading" class="tts-ready-text">
      Ya tienes un audio de referencia generado para esta presentaci√≥n.
    </p>

    <!-- Estado de carga -->
    <div *ngIf="ttsLoading" class="tts-loading">Generando audio‚Ä¶</div>
    <div *ngIf="ttsError" class="alert-error">{{ ttsError }}</div>

    <!-- Cuando ya existe el audio TTS -->
    <div *ngIf="ttsAudioUrl" class="tts-player">
      <div class="player-header">
        <div class="time">
          {{ formatTime(ttsCurrentTime) }} / {{ formatTime(ttsDuration) }}
        </div>

        <div class="speed">
          Velocidad:
          <select [(ngModel)]="ttsPlaybackRate" (change)="changeSpeedTts()">
            <option [value]="0.75">0.75x</option>
            <option [value]="1">1.0x</option>
            <option [value]="1.25">1.25x</option>
            <option [value]="1.5">1.5x</option>
          </select>
        </div>
      </div>

      <!-- Waveform TTS -->
      <div #waveformTts class="waveform"></div>

      <div class="player-controls">
        <button type="button" (click)="togglePlayTts()" [disabled]="!ttsWaveReady">
          {{ ttsIsPlaying ? 'Pausar' : 'Reproducir' }}
        </button>
        <button type="button" (click)="stopTts()" [disabled]="!ttsWaveReady">
          Detener
        </button>
      </div>

      <audio #audioTtsRef preload="auto" style="display:none"></audio>
    </div>
  </div>

  <!-- ========================== -->
  <!-- üõë MODAL DE SELECCI√ìN DE VOZ -->
  <!-- ========================== -->
  <div class="modal-backdrop" *ngIf="showVoiceModal">
    <div class="modal-card">
      <h3>Elige la voz del audio de referencia</h3>
      <p class="modal-sub">
        Selecciona si deseas una voz masculina o femenina.
      </p>

      <div class="voice-options">

        <!-- Mujer -->
        <label class="voice-option">
          <input
            type="radio"
            name="voice"
            (change)="selectedVoice = 'Sulafat'"
          />
          <div>
            <strong>Voz femenina</strong>
            <small>Sulafat</small>
          </div>
        </label>

        <!-- Hombre -->
        <label class="voice-option">
          <input
            type="radio"
            name="voice"
            (change)="selectedVoice = 'Umbriel'"
          />
          <div>
            <strong>Voz masculina</strong>
            <small>Umbriel</small>
          </div>
        </label>

      </div>

      <div class="modal-actions">
        <button type="button" class="btn-cancel" (click)="closeVoiceModal()">
          Cancelar
        </button>
        <button
          type="button"
          class="btn-confirm"
          [disabled]="!selectedVoice"
          (click)="confirmVoiceAndGenerate()"
        >
          Generar
        </button>
      </div>
    </div>
  </div>

</section>