<div class="home-container">
  <!-- Header -->
  <div class="header-section">
    <div class="header-title">
      <h2>Overview</h2>
      <p>Resumen de tu progreso en presentaciones.</p>
    </div>
    <button class="new-presentation" (click)="goToUpload()">Nueva presentación</button>
  </div>

  <section class="dashboard">
    <!-- Línea -->
    <article class="card col-8">
      <h4>Evolución general</h4>
      <div class="chart-box">
        <canvas baseChart [type]="'line'" [options]="lineOptions" [data]="lineData"></canvas>
      </div>
      <div class="kpis" *ngIf="topEmotionLabel">
        <div class="kpi">
          <div class="label">Emoción más frecuente</div>
          <div class="value">{{ topEmotionLabel }} ({{ topEmotionPct }}%)</div>
        </div>
        <div class="kpi">
          <div class="label">Presentaciones</div>
          <div class="value">{{ totalPresentations }}</div>
        </div>
        <div class="kpi">
          <div class="label">Mejor puntaje</div>
          <div class="value">{{ bestScore }}/5</div>
        </div>
        <div class="kpi">
          <div class="label">Promedio</div>
          <div class="value">{{ avgScore }}/5</div>
        </div>
      </div>
    </article>

    <!-- Gauge / Nivel emocional (5 niveles, tipo "estrellas") -->
    <article class="card col-4">
      <div class="card-title-row">
        <h4>Nivel emocional promedio</h4>

        <!-- Botón ayuda -->
        <div class="help-wrap"
             (mouseenter)="showInfo=true" (mouseleave)="showInfo=false"
             (click)="showInfo=!showInfo" aria-label="¿Qué es?">
          <span class="help-icon">?</span>
          <div class="help-popover" *ngIf="showInfo">
            <div class="pop-title">¿Cómo leer esta rueda?</div>
            <ul class="pop-list">
              <li><b>Escala 0–100%:</b> 0% Nervioso · 20% Ansioso · 40% Neutro · 60% Confiado · 80% Motivado · 100% Entusiasta.</li>
              <li><b>Tu posición:</b> 44.6% (Entre Neutro y Confiado, promedio 2.23 / 5).</li>
              <li *ngIf="topEmotionLabel"><b>Emoción más frecuente:</b> {{ topEmotionLabel }} ({{ topEmotionPct }}%).</li>
              <li>
                <b>Progreso total:</b>
                {{ formatSigned(totalDeltaPct) }} pp
                <span *ngIf="totalDeltaLevels !== 0">
                  ({{ formatSigned(totalDeltaLevels) }} niveles)
                </span>
              </li>
            </ul>
            <div class="pop-foot">
              El arco es <b>continuo</b>. Las marcas finas separan bloques de 20%.
              El punto naranja muestra tu porcentaje exacto; el color del tramo solo ayuda a ubicarte.
            </div>
          </div>
        </div>
      </div>

      <div class="gauge-wrap">
        <div class="chart-box sm">
          <canvas
            baseChart
            [type]="'doughnut'"
            [options]="gaugeOptions"
            [plugins]="gaugePlugins"
            [data]="gaugeData">
          </canvas>
        </div>

        <!-- Regleta de 5 pasos para marcar el nivel -->
        <div class="level-steps">
          <span
            class="step"
            *ngFor="let _ of [1,2,3,4,5]; let i = index"
            [style.background]="(i+1)===levelIndex ? levelColor : '#e5e7eb'">
          </span>
        </div>

        <!-- Overlay central: nivel + porcentaje + promedio crudo -->
        <div class="gauge-center">
          <div class="level" [style.color]="levelColor">Nivel {{ levelIndex }}</div>
          <div class="points">{{ scorePercent | number:'1.0-1' }}%</div>
          <div class="unit">POSICIÓN GLOBAL</div>
          <div class="subnote">Promedio: {{ avgRaw | number:'1.2-2' }} / 5</div>
        </div>
      </div>
    </article>

    <!-- Barras por mes -->
    <article class="card col-8">
      <h4>Presentaciones por mes (últimos 6)</h4>
      <div class="chart-box">
        <canvas baseChart [type]="'bar'" [options]="barOptions" [data]="barData"></canvas>
      </div>
    </article>

    <!-- Últimas presentaciones -->
    <article class="card col-4">
      <h4>Últimas presentaciones</h4>
      <div class="list-header">
        <div>Título</div><div>Fecha</div><div>Acción</div>
      </div>
      <div class="list">
        <div class="item" *ngFor="let p of presentations">
          <div class="thumb">
            <img [src]="p.image" alt="">
            <div class="title">{{ p.title }}</div>
          </div>
          <div class="date">{{ p.date }}</div>
          <div class="cta"><a (click)="goToFeedbackConfig(p.id)">Ver</a></div>
        </div>
      </div>
    </article>
  </section>
</div>