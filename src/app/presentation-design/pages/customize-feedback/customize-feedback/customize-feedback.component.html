<!-- ===== Encabezado ===== -->
<h2 class="title">AnÃ¡lisis y Feedback</h2>
<h3 class="subtitle">
  Tu tono refleja cÃ³mo te comunicas. Descubre quÃ© transmite tu voz y cÃ³mo fortalecerla para tu prÃ³xima presentaciÃ³n.
</h3>

<div *ngIf="loading">Cargando feedback...</div>
<div *ngIf="error">âŒ No se pudo cargar el feedback.</div>

<!-- ===== Fila 0: KPI cards ===== -->
<section class="kpi-row" *ngIf="!loading && !error">
  <!-- EmociÃ³n dominante -->
  <article class="kpi-card">
    <div class="kpi-title">EmociÃ³n dominante</div>
    <div class="kpi-main">
      <span class="kpi-dot" [style.background]="emotionColors[domKey]"></span>
      <span class="kpi-strong">{{ emotionLabels[domKey] }}</span>
      <span *ngIf="['confiada','motivada','entusiasta'].includes(domKey)" class="kpi-check">âœ”</span>
    </div>
    <div class="kpi-sub">
      <span class="kpi-badge" [ngClass]="dominantClass">{{ domPct }}%</span>
      <span>&nbsp;estimado</span>
    </div>
  </article>

  <!-- Ansiedad -->
  <article class="kpi-card">
    <div class="kpi-title">Ansiedad estimada</div>
    <div
      class="kpi-badge"
      [ngClass]="{
        'good': getEmotionPercentage('ansiosa') <= 25,
        'warn': getEmotionPercentage('ansiosa') > 25 && getEmotionPercentage('ansiosa') <= 50,
        'danger': getEmotionPercentage('ansiosa') > 50
      }">
      {{ getEmotionPercentage('ansiosa') }}%
    </div>
    <div class="kpi-sub">
      <span *ngIf="getEmotionPercentage('ansiosa') <= 25">Buen control emocional.</span>
      <span *ngIf="getEmotionPercentage('ansiosa') > 25 && getEmotionPercentage('ansiosa') <= 50">Ligera tensiÃ³n manejable.</span>
      <span *ngIf="getEmotionPercentage('ansiosa') > 50">Trabaja la calma al inicio.</span>
    </div>
  </article>

  <article class="kpi-card">
    <div class="kpi-title">Palabras</div>
    <div class="kpi-strong">{{ lang?.total_words ?? 'â€”' }}</div>
    <div class="kpi-sub">conteo total</div>
  </article>

  <article class="kpi-card">
    <div class="kpi-title">Muletillas</div>
    <div class="kpi-strong">{{ lang?.filler_count ?? 0 }}</div>
    <div class="kpi-sub">detectadas</div>
  </article>
</section>

<!-- ===== Grid principal ===== -->
<section class="dash-grid" *ngIf="!loading && !error">
  <!-- Donut -->
  <article class="feedback-block col-7">
    <h4 class="block-title">ğŸ§ CÃ³mo se distribuyeron las emociones en tu voz</h4>
    <div class="subtle">Cada color representa el tono predominante detectado en tu audio.</div>

    <div style="margin-top:10px;">
      <div class="subtle">Equilibrio emocional: {{ starsOverall | number:'1.1-1' }} / 5</div>
      <div class="stars">{{ starsLine(starsOverall) }}</div>
    </div>

    <div class="chart-box">
      <canvas baseChart [type]="'doughnut'" [data]="doughnutData" [options]="doughnutOptions"></canvas>
    </div>

    <div class="legend-grid">
      <div class="legend-item" *ngFor="let key of emotionsOrder">
        <span class="legend-dot" [style.background]="emotionColors[key]"></span>
        <span>{{ emotionLabels[key] || key }}</span>
        <span class="subtle">Â· {{ getEmotionPercentage(key) }}%</span>
      </div>
    </div>
  </article>

  <!-- InterpretaciÃ³n -->
  <article class="feedback-block col-5">
    <h4 class="block-title">INTERPRETACIÃ“N</h4>
    <ul class="bulleted">
      <li *ngIf="feedbackData?.general_feedback as g"><strong>ğŸŸ¢ Lo que comunica tu voz:</strong> {{ g }}</li>
      <li *ngIf="feedbackData?.confidence_feedback as cf"><strong>ğŸŸ¡ Seguridad:</strong> {{ cf }}</li>
      <li *ngIf="feedbackData?.anxiety_feedback as af"><strong>ğŸ”µ RegulaciÃ³n:</strong> {{ af }}</li>
    </ul>
    <p *ngIf="!feedbackData">â€”</p>
  </article>

  <!-- Lenguaje -->
  <article class="feedback-block col-7">
    <h4 class="block-title">LENGUAJE</h4>
    <p>{{ feedbackData?.language_feedback || 'â€”' }}</p>
  </article>

  <!-- ReflexiÃ³n -->
  <article class="feedback-block col-5">
    <h4 class="block-title">ğŸ’­ ReflexiÃ³n inmediata</h4>
    <p>{{ reflectionText }}</p>
  </article>

  <!-- Ejercicios (izq) + Consejos/Recursos (der) -->
  <article class="feedback-block col-7">
    <h4 class="block-title">ğŸ¯ Ejercicios para tu prÃ³xima prÃ¡ctica</h4>
    <ul class="bulleted" *ngIf="suggestionsList?.length; else noSug">
      <li *ngFor="let s of suggestionsList">{{ s }}</li>
    </ul>
    <ng-template #noSug>â€”</ng-template>

    <div style="margin-top:10px;">
      <button class="primary-cta" (click)="goToPractice()">â–¶ï¸ Practicar ahora</button>
    </div>
  </article>

  <article class="feedback-block col-5">
    <h4 class="block-title">ğŸ§© Consejos y recursos</h4>
    <ul class="resource-list">
      <li *ngFor="let r of resourcesList">
        <div class="res-top">
          <span class="chip" [attr.data-tag]="r.tag">{{ r.tag }}</span>
          <a class="res-link" [href]="r.url" target="_blank" rel="noopener">
            {{ r.title }}
          </a>
        </div>
        <div class="res-note">{{ r.note }}</div>
      </li>
    </ul>
  </article>
</section>

<!-- ===== Acciones ===== -->
<div class="feedback-actions">
  <a routerLink="/home" class="link-button">Volver al inicio</a>
  <button mat-flat-button class="download-button">Descargar reporte</button>
</div>