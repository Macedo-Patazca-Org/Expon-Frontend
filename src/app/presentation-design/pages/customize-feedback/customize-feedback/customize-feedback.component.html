<!-- ===== Encabezado ===== -->
<h2 class="title">An√°lisis y Feedback</h2>
<h3 class="subtitle">
  Tu tono refleja c√≥mo te comunicas. Descubre qu√© transmite tu voz y c√≥mo fortalecerla para tu pr√≥xima presentaci√≥n.
</h3>

<div *ngIf="loading">Cargando feedback...</div>
<div *ngIf="error">‚ùå No se pudo cargar el feedback.</div>

<!-- ===== Fila 0: KPI cards ===== -->
<section class="kpi-row" *ngIf="!loading && !error">
  <!-- Emoci√≥n dominante -->
  <article class="kpi-card">
    <div class="kpi-title">Emoci√≥n dominante</div>
    <div class="kpi-main">
      <span class="kpi-dot" [style.background]="emotionColors[domKey]"></span>
      <span class="kpi-strong">{{ emotionLabels[domKey] }}</span>
      <span *ngIf="['confiada','motivada','entusiasta'].includes(domKey)" class="kpi-check">‚úî</span>
    </div>
    <div class="kpi-sub">
      <span class="kpi-badge" [ngClass]="dominantClass">{{ domPct }}%</span>
      <span>&nbsp;estimado</span>
    </div>
  </article>

  <!-- Ansiedad -->
  <article class="kpi-card">
    <div class="kpi-title">Ansiedad estimada</div>
    <div
      class="kpi-badge"
      [ngClass]="{
        'good': getEmotionPercentage('ansiosa') <= 25,
        'warn': getEmotionPercentage('ansiosa') > 25 && getEmotionPercentage('ansiosa') <= 50,
        'danger': getEmotionPercentage('ansiosa') > 50
      }">
      {{ getEmotionPercentage('ansiosa') }}%
    </div>
    <div class="kpi-sub">
      <span *ngIf="getEmotionPercentage('ansiosa') <= 25">Buen control emocional.</span>
      <span *ngIf="getEmotionPercentage('ansiosa') > 25 && getEmotionPercentage('ansiosa') <= 50">Ligera tensi√≥n manejable.</span>
      <span *ngIf="getEmotionPercentage('ansiosa') > 50">Trabaja la calma al inicio.</span>
    </div>
  </article>

  <article class="kpi-card">
    <div class="kpi-title">Palabras</div>
    <div class="kpi-strong">{{ lang?.total_words ?? '‚Äî' }}</div>
    <div class="kpi-sub">conteo total</div>
  </article>

  <article class="kpi-card">
    <div class="kpi-title">Muletillas</div>
    <div class="kpi-strong">{{ lang?.filler_count ?? 0 }}</div>
    <div class="kpi-sub">detectadas</div>
  </article>
</section>

<!-- ===== Grid principal ===== -->
<section class="dash-grid" *ngIf="!loading && !error">
  <!-- Donut -->
  <article class="feedback-block col-7">
    <h4 class="block-title">üéß C√≥mo se distribuyeron las emociones en tu voz</h4>
    <div class="subtle">Cada color representa el tono predominante detectado en tu audio.</div>

    <div style="margin-top:10px;">
      <div class="subtle">Equilibrio emocional: {{ starsOverall | number:'1.1-1' }} / 5</div>
      <div class="stars">{{ starsLine(starsOverall) }}</div>
    </div>

    <div class="chart-box">
      <canvas baseChart [type]="'doughnut'" [data]="doughnutData" [options]="doughnutOptions"></canvas>
    </div>

    <div class="legend-grid">
      <div class="legend-item" *ngFor="let key of emotionsOrder">
        <span class="legend-dot" [style.background]="emotionColors[key]"></span>
        <span>{{ emotionLabels[key] || key }}</span>
        <span class="subtle">¬∑ {{ getEmotionPercentage(key) }}%</span>
      </div>
    </div>
  </article>

  <!-- Interpretaci√≥n -->
  <article class="feedback-block col-5">
    <h4 class="block-title">INTERPRETACI√ìN</h4>
    <ul class="bulleted">
      <li *ngIf="feedbackData?.general_feedback as g"><strong>üü¢ Lo que comunica tu voz:</strong> {{ g }}</li>
      <li *ngIf="feedbackData?.confidence_feedback as cf"><strong>üü° Seguridad:</strong> {{ cf }}</li>
      <li *ngIf="feedbackData?.anxiety_feedback as af"><strong>üîµ Regulaci√≥n:</strong> {{ af }}</li>
    </ul>
    <p *ngIf="!feedbackData">‚Äî</p>
  </article>

  <!-- Lenguaje -->
  <article class="feedback-block col-7">
    <h4 class="block-title">LENGUAJE</h4>

    <ng-container *ngIf="languageBullets?.length; else noLang">
      <ul class="bulleted">
        <li *ngFor="let item of languageBullets">{{ item }}</li>
      </ul>
    </ng-container>

    <ng-template #noLang>‚Äî</ng-template>
  </article>


  <!-- Reflexi√≥n -->
  <article class="feedback-block col-5">
    <h4 class="block-title">üí≠ Reflexi√≥n inmediata</h4>
    <p>{{ reflectionText }}</p>
  </article>

  <!-- Ejercicios (izq) + Consejos/Recursos (der) -->
  <article class="feedback-block col-7">
    <h4 class="block-title">üéØ Ejercicios para tu pr√≥xima pr√°ctica</h4>
    <ul class="bulleted" *ngIf="suggestionsList?.length; else noSug">
      <li *ngFor="let s of suggestionsList">{{ s }}</li>
    </ul>
    <ng-template #noSug>‚Äî</ng-template>

    <div style="margin-top:10px;">
      <button class="primary-cta" (click)="goToPractice()">‚ñ∂Ô∏è Practicar ahora</button>
    </div>
  </article>

  <article class="feedback-block col-5">
    <h4 class="block-title">üß© Consejos y recursos</h4>
    <ul class="resource-list">
      <li *ngFor="let r of resourcesList">
        <div class="res-top">
          <span class="chip" [attr.data-tag]="r.tag">{{ r.tag }}</span>
          <a class="res-link" [href]="r.url" target="_blank" rel="noopener">
            {{ r.title }}
          </a>
        </div>
        <div class="res-note">{{ r.note }}</div>
      </li>
    </ul>
  </article>
</section>

<!-- ===== CONTENIDO PARA EL REPORTE (PDF) ===== -->
<div
  #reportContent
  class="report-container"
  [hidden]="!showReportForPdf"
>

  <!-- ===== Portada ===== -->
  <div class="report-cover report-page">
    <!-- Encabezado con logo -->
    <div class="report-header">
      <!-- Ajusta la ruta del logo seg√∫n tu proyecto -->
      <img src="assets/images/logo-img.png" alt="Logo Expon" class="report-logo" />
      <div class="report-header-text">
        <div class="report-university">UNIVERSIDAD PERUANA DE CIENCIAS APLICADAS</div>
        <div class="report-project">Proyecto Expon ‚Äì An√°lisis Emocional de Presentaciones</div>
      </div>
    </div>

    <!-- T√≠tulo centrado -->
    <div class="report-cover-center">
      <h1>Reporte de an√°lisis emocional de la presentaci√≥n</h1>
      <p class="report-subtitle">
        Resultados generados autom√°ticamente a partir del audio, transcripci√≥n y modelo de emociones.
      </p>

      <div class="report-meta">
        <p><strong>Fecha de an√°lisis:</strong> {{ currentDate | date:'dd/MM/yyyy' }}</p>
        <!-- Si luego quieres puedes interpolar m√°s datos (nombre estudiante, curso, etc.) -->
        <!-- <p><strong>Estudiante:</strong> {{ userName }}</p> -->
        <!-- <p><strong>Curso:</strong> Proyecto de Tesis</p> -->
      </div>
    </div>

    <div class="report-cover-footer">
      <p>Aplicaci√≥n web Expon ‚Äì An√°lisis emocional para presentaciones acad√©micas.</p>
    </div>
  </div>

  <div class="page-break"></div>

  <!-- ===== P√°gina 1 ‚Äì Resumen general ===== -->
  <div class="report-page">
    <h2>1. Resumen general de la presentaci√≥n</h2>
    <p>
      Este reporte resume los resultados del an√°lisis autom√°tico de tu presentaci√≥n, 
      considerando la emoci√≥n dominante, el nivel de ansiedad estimado, el uso del lenguaje y 
      las recomendaciones para futuras pr√°cticas.
    </p>

    <h3>1.1 Indicadores principales</h3>
    <p><strong>Emoci√≥n dominante:</strong> {{ emotionLabels[domKey] }} ({{ domPct }}%)</p>
    <p><strong>Ansiedad estimada:</strong> {{ getEmotionPercentage('ansiosa') }}%</p>
    <p><strong>Palabras totales:</strong> {{ lang?.total_words ?? '‚Äî' }}</p>
    <p><strong>Muletillas detectadas:</strong> {{ lang?.filler_count ?? 0 }}</p>
    <p><strong>Equilibrio emocional global:</strong> {{ starsOverall | number:'1.1-1' }} / 5</p>

    <h3>1.2 Distribuci√≥n de emociones</h3>
    <p>
      La siguiente tabla resume el porcentaje estimado de cada emoci√≥n detectada en tu voz 
      durante la presentaci√≥n.
    </p>

    <table class="report-table">
      <thead>
        <tr>
          <th>Emoci√≥n</th>
          <th>Porcentaje estimado</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let key of emotionsOrder">
          <td>{{ emotionLabels[key] || key }}</td>
          <td>{{ getEmotionPercentage(key) }}%</td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="page-break"></div>

  <!-- ===== P√°gina 2 ‚Äì Interpretaci√≥n y lenguaje ===== -->
  <div class="report-page">
    <h2>2. Interpretaci√≥n cualitativa</h2>

    <h3>2.1 Lo que comunica tu voz</h3>
    <p *ngIf="feedbackData?.general_feedback as g">
      {{ g }}
    </p>
    <p *ngIf="!feedbackData">No se encontr√≥ informaci√≥n de interpretaci√≥n general.</p>

    <h3>2.2 Seguridad percibida</h3>
    <p *ngIf="feedbackData?.confidence_feedback as cf">
      {{ cf }}
    </p>
    <p *ngIf="!feedbackData">No se registr√≥ feedback espec√≠fico sobre la seguridad percibida.</p>

    <h3>2.3 Regulaci√≥n emocional</h3>
    <p *ngIf="feedbackData?.anxiety_feedback as af">
      {{ af }}
    </p>
    <p *ngIf="!feedbackData">No se registr√≥ feedback espec√≠fico sobre regulaci√≥n emocional.</p>

    <h2>3. An√°lisis del lenguaje</h2>
    <ng-container *ngIf="languageBullets?.length; else noLangReport">
      <ul>
        <li *ngFor="let item of languageBullets">{{ item }}</li>
      </ul>
    </ng-container>
    <ng-template #noLangReport>
      <p>No se encontraron observaciones espec√≠ficas sobre el lenguaje.</p>
    </ng-template>
  </div>

  <div class="page-break"></div>

  <!-- ===== P√°gina 3 ‚Äì Reflexi√≥n y recomendaciones ===== -->
  <div class="report-page">
    <h2>4. Reflexi√≥n y recomendaciones</h2>

    <h3>4.1 Reflexi√≥n inmediata</h3>
    <p>
      {{ reflectionText }}
    </p>

    <h3>4.2 Ejercicios sugeridos para la pr√≥xima pr√°ctica</h3>
    <ng-container *ngIf="suggestionsList?.length; else noSugReport">
      <ul>
        <li *ngFor="let s of suggestionsList">{{ s }}</li>
      </ul>
    </ng-container>
    <ng-template #noSugReport>
      <p>No se generaron ejercicios espec√≠ficos para esta presentaci√≥n.</p>
    </ng-template>

    <h3>4.3 Recursos adicionales recomendados</h3>
    <ng-container *ngIf="resourcesList?.length; else noResReport">
      <ul>
        <li *ngFor="let r of resourcesList">
          <strong>{{ r.title }}</strong><br />
          <em>[{{ r.tag }}]</em><br />
          {{ r.note }}<br />
          <span>Enlace: {{ r.url }}</span>
        </li>
      </ul>
    </ng-container>
    <ng-template #noResReport>
      <p>No se registraron recursos adicionales para esta sesi√≥n.</p>
    </ng-template>
  </div>
</div>



<!-- ===== Acciones ===== -->
<div class="feedback-actions">

  <!-- NUEVO BOT√ìN -->
  <button 
    class="link-button audios-btn"
    (click)="goToAudio()"
    style="margin-right: auto;"
  >
    üéß Audio
  </button>

  <a routerLink="/home" class="link-button">Volver al inicio</a>

  <button
    mat-flat-button
    class="download-button"
    (click)="downloadReport()"
  >
    Descargar reporte
  </button>

</div>